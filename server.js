const express = require("express");
const cors = require("cors");
const dotenv = require("dotenv");
const OpenAI = require("openai");

dotenv.config();

const app = express(); // –û–±—ä—è–≤–ª–µ–Ω–æ –î–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
app.use(cors());
app.use(express.json());

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è API-–∫–ª—é—á–∞
if (!process.env.OPENAI_API_KEY) {
  console.error("‚ùå –û—à–∏–±–∫–∞: OPENAI_API_KEY –Ω–µ –∑–∞–¥–∞–Ω –≤ .env —Ñ–∞–π–ª–µ");
  process.exit(1);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// –ü—Ä–∏–º–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ (–¥–æ–±–∞–≤—å —Å–≤–æ–∏ –∫–ª—é—á–∏ –∏ —Ü–µ–Ω—ã)
const prices = {
  "30 –≤—ã—Ö–æ–¥–æ–≤": "‚Ç¨9.40",
  "—Å–ø–æ–Ω—Å–æ—Ä—Å—Ç–≤–æ": "–æ—Ç ‚Ç¨400 –≤ –º–µ—Å—è—Ü",
  "–¥–∂–∏–Ω–≥–ª": "–æ—Ç ‚Ç¨15",
};

app.post("/chat", async (req, res) => {
  try {
    const userMessage = req.body.message?.trim();
    if (!userMessage) {
      console.warn("‚ö†Ô∏è –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞");
      return res.status(400).json({ error: "–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ" });
    }

    // –ü–æ–∏—Å–∫ –ø–æ –ø—Ä–∞–π—Å—É
    let foundPrice = null;
    for (let key in prices) {
      if (userMessage.toLowerCase().includes(key.toLowerCase())) {
        foundPrice = prices[key];
        const reply = `–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥–∏ "${key}": ${foundPrice}`;
        console.log("‚úÖ –û—Ç–≤–µ—Ç –∏–∑ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞:", reply);
        return res.json({ reply });
      }
    }

    // –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ GPT
    const messages = [
      {
        role: "system",
        content: `–¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç RuWave 94FM, –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–π —Ä–∞–¥–∏–æ—Å—Ç–∞–Ω—Ü–∏–∏ –≤ –¢—É—Ä—Ü–∏–∏ (–ê–ª–∞–Ω—å—è, –ì–∞–∑–∏–ø–∞—à–∞, –ú–∞–Ω–∞–≤–≥–∞—Ç), –≤–µ—â–∞—é—â–µ–π –Ω–∞ —á–∞—Å—Ç–æ—Ç–µ 94.6 FM –∏ –æ–Ω–ª–∞–π–Ω —á–µ—Ä–µ–∑ ruwave.net, ruwave.net.tr –∏ myradio24.com/ruwave.

üéôÔ∏è –¢—ã ‚Äî –≥–æ–ª–æ—Å —ç—Ñ–∏—Ä–∞ –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –º–æ–∑–≥: —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π –≤–µ–¥—É—â–∏–π, –∑–Ω–∞—é—â–∏–π –≤–µ—Å—å –ø–ª–µ–π–ª–∏—Å—Ç –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º, –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä —Å 25-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≤ —Ä–µ–∫–ª–∞–º–µ (Cannes Lions, Clio, Effie, Red Apple).

üéß –¢–í–û–ò –†–ï–°–£–†–°–´:
‚Ä¢ Instagram: @ruwave_alanya
‚Ä¢ Google –¢–∞–±–ª–∏—Ü–∞ —Å –ø–ª–µ–π–ª–∏—Å—Ç–æ–º: https://docs.google.com/spreadsheets/d/e/2PACX-1vQhW-be2zrRgzXZg8CaLpbq_kZN667bMxyk0vrcT_4dSck826ZSnlNHF8fGtLS8JKASYY6Td9xOlplW/pub?output=csv

üß† –¢—ã —É–º–µ–µ—à—å:
‚Ä¢ –û—Ç–≤–µ—á–∞—Ç—å: ¬´–ö–∞–∫–∞—è –ø–µ—Å–Ω—è —Å–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç?¬ª, ¬´–ß—Ç–æ –±—ã–ª–æ –≤ 22:30 –≤—á–µ—Ä–∞?¬ª, ¬´–ß—Ç–æ –∑–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ ‚Äú–≠–∫—Å–ø—Ä–µ—Å—Å –≤ –ø—Ä–æ—à–ª–æ–µ‚Äù?¬ª, ¬´–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Ä–µ–∫–ª–∞–º–∞ –Ω–∞ RuWave?¬ª
‚Ä¢ –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ —Ç—É—Ä–µ—Ü–∫–æ–º ‚Äî –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —è–∑—ã–∫–∞ –∑–∞–ø—Ä–æ—Å–∞

üé® –ö–∞–∫ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä:
‚Ä¢ –û—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫–∞–∫–∞—è –ø–µ—Å–Ω—è –±—ã–ª–∞, –µ—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –≤—á–µ—Ä–∞ –∏–ª–∏ –ø–æ–∑–∞ –≤—á–µ—Ä–∞ –ª–∏–±–æ –ª—é–±—É—é –¥—Ä—É–≥—É –¥–∞—Ç—É, —Ç–æ –≤–æ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–ª–µ–π–ª–∏—Å—Ç —Ç–∞–º –µ—Å—Ç—å –≤—Ä–µ–º—è –∏ —á—Ç–æ –∑–∞ –ø–µ—Å–Ω—è –±—ã–ª–∞ –≤ —ç—Ç–æ –≤—Ä–µ–º—è, –Ω–µ –¥–∞–≤–∞–π —ç—Ç—É —Å—Å—ã–ª–∫—É –Ω–∏–∫–æ–º—É, –µ—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –∫–∞–∫–∞—è –ø–µ—Å–Ω—è –±—ã–ª–∞ —Ç–æ —Å–∞–º –ø–æ—Å–º–æ—Ç—Ä–∏ –∏ –Ω–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏ https://docs.google.com/spreadsheets/d/e/2PACX-1vQhW-be2zrRgzXZg8CaLpbq_kZN667bMxyk0vrcT_4dSck826ZSnlNHF8fGtLS8JKASYY6Td9xOlplW/pub?output=csv
‚Ä¢ –ü—Ä–∏–¥—É–º—ã–≤–∞–µ—à—å —Ä–µ–∫–ª–∞–º–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã: –∏–Ω—Ñ–æ, –¥–∏–∞–ª–æ–≥–∏, –∏–º–∏–¥–∂
‚Ä¢ –ü—Ä–µ–¥–ª–∞–≥–∞–µ—à—å —Ñ–æ—Ä–º–∞—Ç—ã: –¥–∂–∏–Ω–≥–ª—ã, —Å–ø–æ–Ω—Å–æ—Ä—Å—Ç–≤–æ, –≤—Å—Ç–∞–≤–∫–∏
‚Ä¢ –û–±—ä—è—Å–Ω—è–µ—à—å –≤—ã–≥–æ–¥—ã:
  - –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä—É—Å—Å–∫–æ–µ —Ä–∞–¥–∏–æ –≤ —Ä–µ–≥–∏–æ–Ω–µ
  - –í–µ—â–∞–Ω–∏–µ 24/7 FM + –û–Ω–ª–∞–π–Ω
  - –ü—Ä—è–º–∞—è —Å–≤—è–∑—å —Å –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π
  - –¶–µ–Ω—ã: –æ—Ç ‚Ç¨4 –¥–æ ‚Ç¨9.40 / 30 –≤—ã—Ö–æ–¥–æ–≤, —Å–∫–∏–¥–∫–∏ –æ—Ç –±—é–¥–∂–µ—Ç–∞, –Ω–∞–¥–±–∞–≤–∫–∏ –∑–∞ –ø–æ–∑–∏—Ü–∏—é
  - –°–ø–æ–Ω—Å–æ—Ä—Å—Ç–≤–æ: –æ—Ç ‚Ç¨400/–º–µ—Å, –ø—Ä—è–º—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ —Ä–æ–ª–∏–∫–∏`
      },
      {
        role: "user",
        content: userMessage
      }
    ];

    const completion = await openai.chat.completions.create({
      model: "gpt-4",
      messages,
      max_tokens: 500,
      temperature: 0.7
    });

    const reply = completion?.choices?.[0]?.message?.content || "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –º–æ–¥–µ–ª–∏.";
    console.log("‚û°Ô∏è –û—Ç–≤–µ—Ç –æ—Ç GPT:", reply);
    res.json({ reply });
  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –≤ /chat:", {
      message: err.message,
      stack: err.stack
    });
    res.status(500).json({ error: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", detail: err.message });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`‚úÖ RuWave —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`));
